# Dockerfile.dev pour le développement frontend avec Vitest
FROM node:20.19.0-alpine


# Install curl and netcat for healthchecks
RUN apk add --no-cache curl netcat-openbsd

WORKDIR /app

# Étape 1 : copier les fichiers nécessaires à l'install Yarn
COPY frontend/package.json frontend/yarn.lock ./

# Étape 2 : installer les dépendances
RUN yarn install --frozen-lockfile

# Étape 3 : copier le reste du code
COPY frontend/ .

# Étape 4 : copier les types partagés
COPY shared/ ../shared/

# Exposer les ports
EXPOSE 5173 8080

# Script de healthcheck simple
RUN echo '#!/bin/sh' > /healthcheck.sh && \
    echo 'while true; do' >> /healthcheck.sh && \
    echo '  echo "HTTP/1.1 200 OK\nContent-Type: text/plain\nContent-Length: 2\n\nOK" | nc -l -p 8080 -q 1' >> /healthcheck.sh && \
    echo 'done' >> /healthcheck.sh && \
    chmod +x /healthcheck.sh

# Debug vitest
RUN npx vitest --version || echo "⚠️ Vitest introuvable"
RUN ls -la node_modules/.bin | grep vitest || echo "⚠️ Vitest non trouvé dans .bin"

# Dev + healthcheck
CMD ["/bin/sh", "-c", "/healthcheck.sh & yarn dev"]