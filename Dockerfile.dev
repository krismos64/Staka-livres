# Dockerfile.dev pour le développement frontend avec Vitest
FROM node:20.19.0-alpine

# Install curl and netcat for healthchecks
RUN apk add --no-cache curl netcat-openbsd

WORKDIR /app

# Étape 1 : copier TOUS les fichiers frontend d'un coup
COPY frontend/ .

# Étape 2 : copier les types partagés
COPY shared/ ../shared/

# Étape 3 : installer les dépendances (une seule fois)
RUN yarn install --frozen-lockfile

# Vérifier que vite et vitest sont installés
RUN yarn list vite || echo "⚠️ Vite non trouvé dans yarn list"
RUN yarn list vitest || echo "⚠️ Vitest non trouvé dans yarn list"

# Debug complet de l'installation
RUN echo "=== DIAGNOSTIC COMPLET ==="
RUN echo "PATH: $PATH"
RUN echo "Working directory: $(pwd)"
RUN echo "Files in /app:"
RUN ls -la
RUN echo "Node modules exists?"
RUN test -d node_modules && echo "✅ node_modules existe" || echo "❌ node_modules manquant"
RUN echo "Vite binary exists?"
RUN test -f node_modules/.bin/vite && echo "✅ vite binary existe" || echo "❌ vite binary manquant"
RUN echo "All binaries in node_modules/.bin:"
RUN ls -la node_modules/.bin/ | grep -E "(vite|vitest)" || echo "❌ Aucun binary vite/vitest trouvé"

# Exposer les ports
EXPOSE 5173 8080

# Script de healthcheck simple
RUN echo '#!/bin/sh' > /healthcheck.sh && \
    echo 'while true; do' >> /healthcheck.sh && \
    echo '  echo "HTTP/1.1 200 OK\nContent-Type: text/plain\nContent-Length: 2\n\nOK" | nc -l -p 8080 -q 1' >> /healthcheck.sh && \
    echo 'done' >> /healthcheck.sh && \
    chmod +x /healthcheck.sh

# Debug vite et vitest
RUN ls -la node_modules/.bin | grep -E "(vite|vitest)" || echo "⚠️ Vite/Vitest non trouvé dans .bin"
RUN yarn vite --version || echo "⚠️ Vite introuvable via yarn"
RUN yarn vitest --version || echo "⚠️ Vitest introuvable via yarn"
RUN npx vite --version || echo "⚠️ Vite introuvable via npx"

# Dev + healthcheck avec restart automatique - utiliser le chemin absolu
CMD ["/bin/sh", "-c", "/healthcheck.sh & ./node_modules/.bin/vite --host 0.0.0.0 --port 5173 || (echo 'Direct vite failed, trying yarn...' && yarn dev)"]