/// <reference types="cypress" />

/**
 * Tests E2E - Paiements Avanc√©s Stripe (Critique)
 * 
 * Tests critiques des fonctionnalit√©s de paiement avanc√©es avec Stripe.
 * Couvre tous les sc√©narios de paiement essentiels, webhooks, gestion d'erreurs
 * et cas d'usage complexes pour assurer la fiabilit√© financi√®re.
 * 
 * Couverture critique :
 * - Webhooks Stripe complets (tous √©v√©nements)
 * - Remboursements et disputes
 * - Paiements √©chelonn√©s et r√©currents  
 * - Gestion des erreurs et r√©cup√©ration
 * - Synchronisation tarifs Stripe ‚Üî BDD
 * - Tests de s√©curit√© paiement
 */

describe("üí≥ Paiements Avanc√©s Stripe - Tests Critiques", () => {
  const testData = {
    client: {
      email: "client.payment@test.com",
      name: "Client Test Payment",
      stripeCustomerId: "cus_test_payment_123"
    },
    testCards: {
      success: "4242424242424242",
      declined: "4000000000000002", 
      insufficient: "4000000000009995",
      expired: "4000000000000069",
      cvc_fail: "4000000000000127",
      disputed: "4000000000000259"
    },
    projects: {
      simple: { title: "Test Simple", pages: 100, amount: 200 },
      complex: { title: "Test Complexe", pages: 500, amount: 1000 },
      urgent: { title: "Test Urgent", pages: 150, amount: 450, priority: "urgent" }
    },
    webhookEvents: [
      "payment_intent.succeeded",
      "payment_intent.payment_failed", 
      "charge.dispute.created",
      "invoice.payment_succeeded",
      "customer.subscription.updated"
    ]
  };

  beforeEach(() => {
    // Configuration pour tests paiement critiques
    cy.resetDatabase();
    cy.visit("/");
    cy.wait(2000);

    // V√©rifier que Stripe est configur√©
    cy.window().then((win) => {
      expect(win.Stripe).to.exist;
    });
  });

  context("üîó Webhooks Stripe Complets", () => {
    it("devrait traiter tous les webhooks Stripe essentiels", () => {
      // Cr√©er un projet pour les tests webhooks
      cy.loginAsUser();
      cy.visit("/commander");
      
      cy.get('[data-cy="project-title"]').type(testData.projects.simple.title);
      cy.get('[data-cy="project-pages"]').type(testData.projects.simple.pages.toString());
      cy.get('[data-cy="validate-order"]').click();

      // D√©clencher une session de paiement
      cy.get('[data-cy="proceed-payment"]').click();
      cy.url({ timeout: 15000 }).should("include", "/paiement");

      // Sauvegarder les d√©tails de la session
      let sessionId: string;
      let paymentIntentId: string;

      cy.window().then((win) => {
        // R√©cup√©rer les identifiants depuis l'interface Stripe
        cy.get('[data-cy="stripe-session-id"]')
          .invoke("attr", "data-session-id")
          .then((id) => {
            sessionId = id;
            cy.wrap(sessionId).as("sessionId");
          });
      });

      // === TEST WEBHOOK: payment_intent.succeeded ===
      cy.task("log", "üîπ Test webhook: payment_intent.succeeded");
      
      cy.simulateStripePayment();
      
      // Simuler le webhook Stripe
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: {
          "Stripe-Signature": "test-signature",
          "Content-Type": "application/json"
        },
        body: {
          id: "evt_payment_succeeded_123",
          type: "payment_intent.succeeded",
          data: {
            object: {
              id: "pi_test_success_123",
              amount: testData.projects.simple.amount * 100,
              currency: "eur",
              status: "succeeded",
              metadata: {
                projectId: "project_test_123",
                clientEmail: testData.client.email
              }
            }
          },
          created: Math.floor(Date.now() / 1000)
        }
      }).then((response) => {
        expect(response.status).to.eq(200);
        expect(response.body.received).to.be.true;
      });

      // V√©rifier le traitement du webhook
      cy.get('[data-cy="payment-success"]', { timeout: 20000 })
        .should("be.visible")
        .should("contain", "Paiement confirm√©");

      // === TEST WEBHOOK: charge.dispute.created ===
      cy.task("log", "üîπ Test webhook: charge.dispute.created");

      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: {
          "Stripe-Signature": "test-signature",
          "Content-Type": "application/json"
        },
        body: {
          id: "evt_dispute_created_123",
          type: "charge.dispute.created",
          data: {
            object: {
              id: "dp_test_dispute_123",
              amount: testData.projects.simple.amount * 100,
              currency: "eur",
              reason: "fraudulent",
              status: "warning_needs_response",
              charge: "ch_test_charge_123",
              metadata: {
                projectId: "project_test_123"
              }
            }
          }
        }
      });

      // V√©rifier la gestion de dispute c√¥t√© admin
      cy.logout();
      cy.loginAsAdmin();
      cy.visit("/admin/disputes");

      cy.get('[data-cy="active-disputes"]', { timeout: 15000 })
        .should("be.visible")
        .should("contain", "1 dispute active")
        .should("contain", "fraudulent")
        .should("contain", testData.projects.simple.title);

      cy.get('[data-cy="dispute-details"]')
        .should("contain", "R√©ponse requise")
        .should("contain", "dp_test_dispute_123");

      // === TEST WEBHOOK: payment_intent.payment_failed ===
      cy.task("log", "üîπ Test webhook: payment_intent.payment_failed");

      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: {
          id: "evt_payment_failed_123",
          type: "payment_intent.payment_failed",
          data: {
            object: {
              id: "pi_test_failed_123",
              amount: 50000,
              currency: "eur",
              status: "requires_payment_method",
              last_payment_error: {
                code: "card_declined",
                decline_code: "insufficient_funds",
                message: "Your card has insufficient funds."
              },
              metadata: {
                projectId: "project_failed_123",
                clientEmail: testData.client.email
              }
            }
          }
        }
      });

      // V√©rifier les notifications d'√©chec
      cy.visit("/admin/payment-failures");

      cy.get('[data-cy="failed-payments"]', { timeout: 10000 })
        .should("contain", "pi_test_failed_123")
        .should("contain", "insufficient_funds")
        .should("contain", "Client notifi√© automatiquement");
    });

    it("devrait valider les signatures webhook pour la s√©curit√©", () => {
      // Test avec signature invalide
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: {
          "Stripe-Signature": "invalid-signature",
          "Content-Type": "application/json"
        },
        body: {
          id: "evt_invalid_signature",
          type: "payment_intent.succeeded",
          data: { object: { id: "pi_fake_123" } }
        },
        failOnStatusCode: false
      }).then((response) => {
        expect(response.status).to.eq(400);
        expect(response.body.error).to.contain("Invalid signature");
      });

      // Test avec signature valide (simul√©e)
      cy.request({
        method: "POST", 
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: {
          "Stripe-Signature": "t=1234567890,v1=valid-test-signature-hash",
          "Content-Type": "application/json"
        },
        body: {
          id: "evt_valid_signature",
          type: "payment_intent.succeeded",
          data: {
            object: {
              id: "pi_valid_signature_123",
              amount: 20000,
              status: "succeeded"
            }
          }
        }
      }).then((response) => {
        expect(response.status).to.eq(200);
        expect(response.body.received).to.be.true;
      });

      // V√©rifier les logs de s√©curit√©
      cy.loginAsAdmin();
      cy.visit("/admin/security-logs");

      cy.get('[data-cy="webhook-security-logs"]', { timeout: 10000 })
        .should("contain", "Signature webhook invalide bloqu√©e")
        .should("contain", "Tentative d'acc√®s non autoris√©");
    });

    it("devrait g√©rer l'idempotence des webhooks (doublons)", () => {
      const duplicateWebhook = {
        id: "evt_duplicate_test_123", // M√™me ID
        type: "payment_intent.succeeded",
        data: {
          object: {
            id: "pi_duplicate_test_123",
            amount: 30000,
            status: "succeeded",
            metadata: { projectId: "project_duplicate_123" }
          }
        }
      };

      // Premier envoi du webhook
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: duplicateWebhook
      }).then((response) => {
        expect(response.status).to.eq(200);
        expect(response.body.processed).to.be.true;
      });

      // Deuxi√®me envoi du m√™me webhook (doublon)
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: duplicateWebhook
      }).then((response) => {
        expect(response.status).to.eq(200);
        expect(response.body.processed).to.be.false;
        expect(response.body.message).to.contain("Already processed");
      });

      // V√©rifier qu'une seule transaction a √©t√© cr√©√©e
      cy.loginAsAdmin();
      cy.visit("/admin/transactions");

      cy.get('[data-cy="transaction-list"]')
        .should("contain", "pi_duplicate_test_123");

      cy.get('[data-cy="transaction-list"] [data-transaction-id="pi_duplicate_test_123"]')
        .should("have.length", 1); // Une seule occurrence
    });
  });

  context("üí∞ Remboursements et Disputes", () => {
    it("devrait traiter les remboursements complets et partiels", () => {
      // Cr√©er un projet pay√©
      cy.createPaidProject("Projet Remboursement").then((projectId) => {
        cy.loginAsAdmin();
        cy.visit(`/admin/projects/${projectId}`);

        // Interface de remboursement
        cy.get('[data-cy="project-actions"]').click();
        cy.get('[data-cy="process-refund"]').click();

        cy.get('[data-cy="refund-modal"]', { timeout: 10000 })
          .should("be.visible");

        // Test remboursement partiel
        cy.get('[data-cy="refund-type"]').select("partial");
        cy.get('[data-cy="refund-amount"]').type("150"); // Remboursement de 150‚Ç¨
        cy.get('[data-cy="refund-reason"]').select("client-request");
        cy.get('[data-cy="refund-notes"]')
          .type("Client insatisfait de la qualit√© de correction du chapitre 3");

        cy.get('[data-cy="process-refund-btn"]').click();

        // Simuler la r√©ponse Stripe
        cy.intercept("POST", "**/stripe/refunds", {
          statusCode: 200,
          body: {
            id: "re_test_refund_123",
            amount: 15000, // 150‚Ç¨ en centimes
            currency: "eur",
            status: "succeeded",
            charge: "ch_test_charge_123"
          }
        }).as("stripeRefund");

        cy.wait("@stripeRefund");

        // V√©rifier le traitement du remboursement
        cy.get('[data-cy="refund-success"]', { timeout: 15000 })
          .should("be.visible")
          .should("contain", "Remboursement trait√© avec succ√®s")
          .should("contain", "150‚Ç¨")
          .should("contain", "re_test_refund_123");

        // V√©rifier la notification client
        cy.get('[data-cy="client-notification"]')
          .should("contain", "Client notifi√© automatiquement")
          .should("contain", "Email de confirmation envoy√©");

        // V√©rifier l'historique des remboursements
        cy.visit("/admin/refunds");

        cy.get('[data-cy="refund-history"]', { timeout: 10000 })
          .should("contain", "Projet Remboursement")
          .should("contain", "150‚Ç¨")
          .should("contain", "Partiel")
          .should("contain", "client-request");

        // Test remboursement complet
        cy.visit(`/admin/projects/${projectId}`);
        cy.get('[data-cy="project-actions"]').click();
        cy.get('[data-cy="process-refund"]').click();

        cy.get('[data-cy="refund-type"]').select("full");
        cy.get('[data-cy="refund-reason"]').select("service-issue");
        cy.get('[data-cy="refund-notes"]')
          .type("Probl√®me technique majeur - remboursement complet accord√©");

        cy.get('[data-cy="process-refund-btn"]').click();

        // V√©rifier les validations
        cy.get('[data-cy="refund-warning"]')
          .should("contain", "Remboursement complet supprimera le projet")
          .should("contain", "Cette action est irr√©versible");

        cy.get('[data-cy="confirm-full-refund"]').click();

        cy.get('[data-cy="full-refund-success"]', { timeout: 15000 })
          .should("be.visible")
          .should("contain", "Remboursement complet trait√©");

        // V√©rifier que le projet est archiv√©
        cy.visit("/admin/projets");
        cy.get('[data-cy="project-list"]')
          .should("not.contain", "Projet Remboursement");

        cy.visit("/admin/archived-projects");
        cy.get('[data-cy="archived-list"]')
          .should("contain", "Projet Remboursement")
          .should("contain", "Rembours√© int√©gralement");
      });
    });

    it("devrait g√©rer les disputes automatiquement avec preuves", () => {
      cy.createPaidProject("Projet Dispute").then((projectId) => {
        // Simuler une dispute Stripe
        cy.request({
          method: "POST",
          url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
          headers: { "Stripe-Signature": "test-signature" },
          body: {
            id: "evt_dispute_advanced_123",
            type: "charge.dispute.created",
            data: {
              object: {
                id: "dp_advanced_dispute_123",
                amount: 50000, // 500‚Ç¨
                currency: "eur",
                reason: "unrecognized",
                status: "warning_needs_response",
                evidence_deadline: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60), // 7 jours
                charge: "ch_dispute_charge_123",
                metadata: {
                  projectId: projectId
                }
              }
            }
          }
        });

        cy.loginAsAdmin();
        cy.visit("/admin/disputes");

        // Interface de gestion des disputes
        cy.get('[data-cy="dispute-list"]', { timeout: 15000 })
          .should("contain", "dp_advanced_dispute_123")
          .should("contain", "unrecognized")
          .should("contain", "7 jours restants");

        cy.get('[data-cy="dispute-list"]')
          .contains("dp_advanced_dispute_123")
          .closest('[data-cy="dispute-row"]')
          .within(() => {
            cy.get('[data-cy="handle-dispute"]').click();
          });

        // Workspace de gestion de dispute
        cy.get('[data-cy="dispute-workspace"]', { timeout: 10000 })
          .should("be.visible");

        // Collecte automatique des preuves
        cy.get('[data-cy="auto-evidence-collection"]').click();

        cy.get('[data-cy="evidence-progress"]', { timeout: 20000 })
          .should("contain", "Collecte des preuves en cours...");

        // V√©rifier les preuves collect√©es
        cy.get('[data-cy="collected-evidence"]', { timeout: 30000 })
          .should("be.visible");

        cy.get('[data-cy="evidence-list"]').within(() => {
          cy.get('[data-cy="evidence-transaction"]')
            .should("contain", "D√©tails de la transaction")
            .should("contain", "Horodatage");

          cy.get('[data-cy="evidence-communication"]')
            .should("contain", "Historique des communications")
            .should("contain", "Emails √©chang√©s");

          cy.get('[data-cy="evidence-delivery"]')
            .should("contain", "Preuve de livraison")
            .should("contain", "Accus√© de r√©ception");

          cy.get('[data-cy="evidence-contract"]')
            .should("contain", "Conditions de service")
            .should("contain", "Acceptation client");
        });

        // Ajouter des preuves manuelles
        cy.get('[data-cy="add-manual-evidence"]').click();
        
        cy.get('[data-cy="evidence-type"]').select("additional-documentation");
        cy.get('[data-cy="evidence-description"]')
          .type("Correspondance email suppl√©mentaire prouvant la satisfaction initiale du client");
        
        cy.get('[data-cy="evidence-file"]')
          .selectFile("cypress/fixtures/dispute-evidence.pdf", { force: true });

        cy.get('[data-cy="add-evidence"]').click();

        // Soumettre la d√©fense √† Stripe
        cy.get('[data-cy="submit-dispute-response"]').click();

        cy.get('[data-cy="dispute-submission-summary"]', { timeout: 10000 })
          .should("be.visible")
          .should("contain", "4 preuves collect√©es")
          .should("contain", "1 preuve manuelle")
          .should("contain", "Pr√™t pour soumission");

        cy.get('[data-cy="confirm-submission"]').click();

        // Simuler la soumission √† Stripe
        cy.intercept("POST", "**/stripe/disputes/*/submit", {
          statusCode: 200,
          body: {
            id: "dp_advanced_dispute_123",
            status: "under_review",
            evidence_details: {
              submission_count: 1,
              has_evidence: true
            }
          }
        }).as("disputeSubmission");

        cy.wait("@disputeSubmission");

        cy.get('[data-cy="dispute-submitted"]', { timeout: 15000 })
          .should("be.visible")
          .should("contain", "D√©fense soumise √† Stripe")
          .should("contain", "Statut: En cours d'examen");

        // Suivi de la dispute
        cy.get('[data-cy="dispute-tracking"]')
          .should("contain", "R√©ponse estim√©e: 7-10 jours")
          .should("contain", "Notifications automatiques activ√©es");
      });
    });

    it("devrait calculer automatiquement les frais de dispute", () => {
      const disputeData = {
        amount: 75000, // 750‚Ç¨
        disputeFee: 1500, // 15‚Ç¨ frais Stripe
        handlingFee: 2500 // 25‚Ç¨ frais de gestion interne
      };

      // Simuler une dispute avec calcul des frais
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: {
          id: "evt_dispute_fees_123",
          type: "charge.dispute.created",
          data: {
            object: {
              id: "dp_fees_calculation_123",
              amount: disputeData.amount,
              currency: "eur",
              reason: "fraudulent",
              status: "warning_needs_response",
              balance_transactions: [{
                amount: -disputeData.disputeFee, // Frais Stripe
                fee: 0,
                net: -disputeData.disputeFee,
                type: "dispute"
              }]
            }
          }
        }
      });

      cy.loginAsAdmin();
      cy.visit("/admin/financial-impact");

      // Analyser l'impact financier
      cy.get('[data-cy="dispute-impact"]', { timeout: 15000 })
        .should("be.visible");

      cy.get('[data-cy="dispute-costs"]').within(() => {
        cy.get('[data-cy="disputed-amount"]')
          .should("contain", "750‚Ç¨");

        cy.get('[data-cy="stripe-fees"]')
          .should("contain", "15‚Ç¨");

        cy.get('[data-cy="handling-fees"]')
          .should("contain", "25‚Ç¨"); // Calcul√© automatiquement

        cy.get('[data-cy="total-risk"]')
          .should("contain", "790‚Ç¨"); // 750 + 15 + 25
      });

      // Recommandations automatiques
      cy.get('[data-cy="cost-recommendations"]')
        .should("contain", "Dispute recommand√©e") // Montant √©lev√©
        .should("contain", "Preuves solides collect√©es")
        .should("contain", "Probabilit√© de succ√®s: 75%");

      // Impact sur les m√©triques
      cy.visit("/admin/kpis");

      cy.get('[data-cy="dispute-metrics"]', { timeout: 10000 })
        .should("contain", "Taux de dispute: 1.2%")
        .should("contain", "Co√ªt moyen dispute: 40‚Ç¨")
        .should("contain", "Taux de succ√®s d√©fense: 80%");
    });
  });

  context("üìÖ Paiements √âchelonn√©s et R√©currents", () => {
    it("devrait g√©rer les paiements en plusieurs fois", () => {
      const installmentProject = {
        title: "Grand Projet √âchelonn√©",
        totalAmount: 1500, // 1500‚Ç¨
        installments: 3, // 3 fois 500‚Ç¨
        frequency: "monthly"
      };

      cy.loginAsUser();
      cy.visit("/commander");

      // Commander un gros projet
      cy.get('[data-cy="project-title"]').type(installmentProject.title);
      cy.get('[data-cy="project-pages"]').type("750");
      cy.get('[data-cy="project-complexity"]').select("Tr√®s √©lev√©e");

      // Option paiement √©chelonn√©
      cy.get('[data-cy="payment-options"]').click();
      cy.get('[data-cy="installment-payment"]').check();

      cy.get('[data-cy="installment-config"]', { timeout: 10000 })
        .should("be.visible");

      cy.get('[data-cy="installment-count"]').select("3");
      cy.get('[data-cy="installment-frequency"]').select("monthly");

      // V√©rifier le calcul automatique
      cy.get('[data-cy="installment-breakdown"]')
        .should("contain", "3 √ó 500‚Ç¨")
        .should("contain", "Premier paiement: Imm√©diat")
        .should("contain", "Paiements suivants: Mensuel");

      cy.get('[data-cy="validate-order"]').click();

      // Premi√®re √©ch√©ance (imm√©diate)
      cy.get('[data-cy="first-installment"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Premier paiement: 500‚Ç¨");

      cy.get('[data-cy="proceed-first-payment"]').click();
      cy.simulateStripePayment();

      // V√©rifier la cr√©ation de la subscription
      cy.get('[data-cy="subscription-created"]', { timeout: 20000 })
        .should("be.visible")
        .should("contain", "Plan de paiement activ√©")
        .should("contain", "Prochaine √©ch√©ance");

      // V√©rifier c√¥t√© admin
      cy.logout();
      cy.loginAsAdmin();
      cy.visit("/admin/subscriptions");

      cy.get('[data-cy="active-subscriptions"]', { timeout: 10000 })
        .should("contain", installmentProject.title)
        .should("contain", "2 paiements restants")
        .should("contain", "500‚Ç¨/mois");

      // Simuler le webhook de paiement r√©current
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: {
          id: "evt_subscription_payment_123",
          type: "invoice.payment_succeeded",
          data: {
            object: {
              id: "in_installment_payment_123",
              amount_paid: 50000, // 500‚Ç¨
              subscription: "sub_installment_123",
              customer: testData.client.stripeCustomerId,
              status: "paid",
              metadata: {
                projectId: "project_installment_123",
                installmentNumber: "2"
              }
            }
          }
        }
      });

      // V√©rifier la mise √† jour
      cy.reload();
      cy.wait(3000);

      cy.get('[data-cy="subscription-progress"]')
        .should("contain", "2/3 paiements effectu√©s")
        .should("contain", "Prochaine √©ch√©ance:");

      // V√©rifier les notifications automatiques
      cy.get('[data-cy="automatic-notifications"]')
        .should("contain", "Client notifi√© du paiement")
        .should("contain", "Rappel programm√© pour prochaine √©ch√©ance");
    });

    it("devrait g√©rer les √©checs de paiements r√©currents", () => {
      // Simuler un √©chec de paiement sur subscription
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
        headers: { "Stripe-Signature": "test-signature" },
        body: {
          id: "evt_subscription_failed_123",
          type: "invoice.payment_failed",
          data: {
            object: {
              id: "in_failed_payment_123",
              amount_due: 50000,
              subscription: "sub_failed_payment_123",
              customer: testData.client.stripeCustomerId,
              status: "open",
              attempt_count: 1,
              next_payment_attempt: Math.floor(Date.now() / 1000) + (3 * 24 * 60 * 60), // +3 jours
              last_finalization_error: {
                code: "card_declined",
                decline_code: "insufficient_funds"
              },
              metadata: {
                projectId: "project_failed_installment_123"
              }
            }
          }
        }
      });

      cy.loginAsAdmin();
      cy.visit("/admin/payment-failures");

      // V√©rifier la gestion des √©checs
      cy.get('[data-cy="failed-recurring-payments"]', { timeout: 15000 })
        .should("be.visible")
        .should("contain", "in_failed_payment_123")
        .should("contain", "insufficient_funds")
        .should("contain", "Tentative 1/3");

      // Actions de r√©cup√©ration automatiques
      cy.get('[data-cy="recovery-actions"]')
        .should("contain", "Email de relance envoy√©")
        .should("contain", "Prochaine tentative: 3 jours")
        .should("contain", "M√©thode de paiement √† mettre √† jour");

      // Simuler plusieurs √©checs cons√©cutifs
      [2, 3].forEach((attemptCount) => {
        cy.request({
          method: "POST",
          url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
          headers: { "Stripe-Signature": "test-signature" },
          body: {
            id: `evt_subscription_failed_${attemptCount}_123`,
            type: "invoice.payment_failed",
            data: {
              object: {
                id: "in_failed_payment_123",
                attempt_count: attemptCount,
                status: attemptCount === 3 ? "void" : "open",
                metadata: { projectId: "project_failed_installment_123" }
              }
            }
          }
        });
      });

      // Apr√®s 3 √©checs, suspension automatique
      cy.reload();
      cy.wait(3000);

      cy.get('[data-cy="suspended-subscriptions"]')
        .should("contain", "project_failed_installment_123")
        .should("contain", "Suspendu apr√®s 3 √©checs")
        .should("contain", "Client contact√© pour r√©solution");

      // Plan de r√©cup√©ration
      cy.get('[data-cy="recovery-plan"]')
        .should("contain", "Contact t√©l√©phonique programm√©")
        .should("contain", "Proposition de nouveau plan")
        .should("contain", "Remise de r√©cup√©ration: 10%");
    });

    it("devrait optimiser les plans de paiement selon le profil client", () => {
      const clientProfiles = [
        {
          type: "premium",
          creditScore: "excellent",
          paymentHistory: "perfect",
          recommendedPlan: "flexible"
        },
        {
          type: "standard", 
          creditScore: "good",
          paymentHistory: "good",
          recommendedPlan: "standard"
        },
        {
          type: "new",
          creditScore: "unknown",
          paymentHistory: "none",
          recommendedPlan: "secure"
        }
      ];

      clientProfiles.forEach((profile, index) => {
        // Cr√©er un profil client sp√©cifique
        cy.request({
          method: "POST",
          url: `${Cypress.env("API_BASE_URL")}/dev/create-client-profile`,
          body: {
            email: `client.${profile.type}@test.com`,
            profile: profile
          }
        });

        // Login avec ce profil
        cy.loginAsUser();
        cy.visit("/commander");

        cy.get('[data-cy="project-title"]').type(`Projet ${profile.type} ${index}`);
        cy.get('[data-cy="project-pages"]').type("300");
        cy.get('[data-cy="payment-options"]').click();

        // L'IA devrait proposer le plan adapt√©
        cy.get('[data-cy="ai-payment-recommendations"]', { timeout: 15000 })
          .should("be.visible")
          .should("contain", `Plan recommand√©: ${profile.recommendedPlan}`);

        if (profile.type === "premium") {
          cy.get('[data-cy="premium-options"]')
            .should("contain", "Paiement diff√©r√© disponible")
            .should("contain", "Conditions pr√©f√©rentielles")
            .should("contain", "Remise fid√©lit√©: 5%");
        
        } else if (profile.type === "new") {
          cy.get('[data-cy="security-requirements"]')
            .should("contain", "Premier paiement requis")
            .should("contain", "V√©rification renforc√©e")
            .should("contain", "Limite initiale: 500‚Ç¨");
        }

        // V√©rifier les conditions propos√©es
        cy.get('[data-cy="payment-conditions"]').within(() => {
          if (profile.recommendedPlan === "flexible") {
            cy.should("contain", "Jusqu'√† 6 mensualit√©s");
            cy.should("contain", "Aucun frais");
          } else if (profile.recommendedPlan === "secure") {
            cy.should("contain", "Maximum 2 mensualit√©s");
            cy.should("contain", "Caution: 50‚Ç¨");
          }
        });

        cy.logout();
      });

      // Analyser l'efficacit√© des recommandations IA
      cy.loginAsAdmin();
      cy.visit("/admin/payment-ai-analytics");

      cy.get('[data-cy="ai-recommendations-performance"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Taux d'acceptation: 94%")
        .should("contain", "R√©duction des impay√©s: 67%")
        .should("contain", "Satisfaction client: 4.8/5");
    });
  });

  context("üõ°Ô∏è S√©curit√© et R√©cup√©ration", () => {
    it("devrait d√©tecter et bloquer les tentatives frauduleuses", () => {
      const fraudPatterns = [
        {
          type: "multiple-cards-same-ip",
          cards: [testData.testCards.success, testData.testCards.declined, testData.testCards.expired],
          ip: "192.168.1.100"
        },
        {
          type: "velocity-fraud",
          rapidPayments: 5,
          timeWindow: "5-minutes"
        },
        {
          type: "suspicious-amounts",
          amounts: [99999, 99998, 99997] // Juste sous la limite
        }
      ];

      // Simuler des patterns frauduleux
      fraudPatterns[0].cards.forEach((cardNumber, index) => {
        cy.request({
          method: "POST",
          url: `${Cypress.env("API_BASE_URL")}/payments/attempt`,
          headers: {
            "X-Forwarded-For": fraudPatterns[0].ip,
            "User-Agent": "Same-Bot/1.0"
          },
          body: {
            amount: 20000,
            cardNumber: cardNumber,
            projectId: `fraud_test_${index}`
          },
          failOnStatusCode: false
        });
      });

      // V√©rifier la d√©tection de fraude
      cy.loginAsAdmin();
      cy.visit("/admin/fraud-detection");

      cy.get('[data-cy="fraud-alerts"]', { timeout: 15000 })
        .should("be.visible")
        .should("contain", "Pattern frauduleux d√©tect√©")
        .should("contain", "Multiples cartes m√™me IP")
        .should("contain", "IP bloqu√©e: 192.168.1.100");

      // V√©rifier les actions automatiques
      cy.get('[data-cy="auto-fraud-actions"]')
        .should("contain", "IP ajout√©e √† la liste noire")
        .should("contain", "Transactions suspendues")
        .should("contain", "√âquipe s√©curit√© notifi√©e");

      // Test de d√©blocage manuel
      cy.get('[data-cy="blocked-ips"]')
        .contains("192.168.1.100")
        .closest('[data-cy="blocked-ip-row"]')
        .within(() => {
          cy.get('[data-cy="review-block"]').click();
        });

      cy.get('[data-cy="block-review-modal"]', { timeout: 10000 })
        .should("be.visible");

      cy.get('[data-cy="block-reason"]')
        .should("contain", "Multiple payment attempts")
        .should("contain", "Risk score: 95/100");

      // D√©bloquer apr√®s v√©rification
      cy.get('[data-cy="unblock-ip"]').click();
      cy.get('[data-cy="unblock-reason"]')
        .type("V√©rification manuelle effectu√©e - client l√©gitime confirm√©");
      
      cy.get('[data-cy="confirm-unblock"]').click();

      cy.get('[data-cy="ip-unblocked"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "IP d√©bloqu√©e avec succ√®s");
    });

    it("devrait impl√©menter la r√©cup√©ration automatique des paiements √©chou√©s", () => {
      const recoveryScenarios = [
        {
          failureType: "insufficient_funds",
          retryDelay: "3-days",
          retryCount: 3,
          recovery: "smart-retry"
        },
        {
          failureType: "expired_card",
          retryDelay: "immediate", 
          retryCount: 0,
          recovery: "update-payment-method"
        },
        {
          failureType: "network_error",
          retryDelay: "1-hour",
          retryCount: 5,
          recovery: "automatic-retry"
        }
      ];

      recoveryScenarios.forEach((scenario, index) => {
        // Simuler l'√©chec de paiement
        cy.request({
          method: "POST",
          url: `${Cypress.env("API_BASE_URL")}/webhooks/stripe`,
          headers: { "Stripe-Signature": "test-signature" },
          body: {
            id: `evt_recovery_${index}_123`,
            type: "payment_intent.payment_failed",
            data: {
              object: {
                id: `pi_recovery_${index}_123`,
                amount: 30000,
                status: "requires_payment_method",
                last_payment_error: {
                  code: "card_declined",
                  decline_code: scenario.failureType
                },
                metadata: {
                  projectId: `project_recovery_${index}`,
                  clientEmail: `client.recovery.${index}@test.com`
                }
              }
            }
          }
        });
      });

      // V√©rifier les strat√©gies de r√©cup√©ration
      cy.loginAsAdmin();
      cy.visit("/admin/payment-recovery");

      cy.get('[data-cy="recovery-strategies"]', { timeout: 15000 })
        .should("be.visible");

      // V√©rifier les diff√©rentes approches
      recoveryScenarios.forEach((scenario, index) => {
        cy.get(`[data-cy="recovery-${index}"]`).within(() => {
          cy.should("contain", scenario.failureType);
          cy.should("contain", scenario.recovery);
          
          if (scenario.recovery === "smart-retry") {
            cy.should("contain", `Retry dans ${scenario.retryDelay}`);
            cy.should("contain", `${scenario.retryCount} tentatives max`);
          }
          
          if (scenario.recovery === "update-payment-method") {
            cy.should("contain", "Email envoy√© pour mise √† jour");
            cy.should("contain", "Lien s√©curis√© g√©n√©r√©");
          }
          
          if (scenario.recovery === "automatic-retry") {
            cy.should("contain", "Retry automatique activ√©");
            cy.should("contain", "Monitoring continu");
          }
        });
      });

      // Simuler une r√©cup√©ration r√©ussie
      cy.request({
        method: "POST",
        url: `${Cypress.env("API_BASE_URL")}/payments/recovery-success`,
        body: {
          originalPaymentId: "pi_recovery_0_123",
          newPaymentId: "pi_recovered_success_123",
          recoveryMethod: "smart-retry",
          attemptNumber: 2
        }
      });

      // V√©rifier les m√©triques de r√©cup√©ration
      cy.visit("/admin/recovery-analytics");

      cy.get('[data-cy="recovery-stats"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Taux de r√©cup√©ration: 78%")
        .should("contain", "Temps moyen de r√©cup√©ration: 2.3 jours")
        .should("contain", "Revenus r√©cup√©r√©s ce mois:");

      cy.get('[data-cy="recovery-breakdown"]')
        .should("contain", "Smart retry: 45%")
        .should("contain", "Payment update: 28%")
        .should("contain", "Manual contact: 5%");
    });

    it("devrait chiffrer et s√©curiser toutes les donn√©es de paiement", () => {
      // Test de s√©curit√© des donn√©es sensibles
      cy.loginAsAdmin();
      cy.visit("/admin/security-compliance");

      // V√©rifier le chiffrement des donn√©es
      cy.get('[data-cy="encryption-status"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Toutes les donn√©es chiffr√©es")
        .should("contain", "AES-256 actif")
        .should("contain", "Cl√©s rot√©es r√©guli√®rement");

      // V√©rifier la conformit√© PCI DSS
      cy.get('[data-cy="pci-compliance"]')
        .should("contain", "PCI DSS Level 1 compliant")
        .should("contain", "Aucune donn√©e de carte stock√©e")
        .should("contain", "Tokens Stripe uniquement");

      // Test d'audit des acc√®s
      cy.get('[data-cy="run-security-audit"]').click();

      cy.get('[data-cy="audit-progress"]', { timeout: 20000 })
        .should("be.visible");

      cy.get('[data-cy="audit-results"]', { timeout: 30000 })
        .should("be.visible");

      cy.get('[data-cy="security-score"]')
        .should("contain", "Score s√©curit√©: A+")
        .should("contain", "Aucune vuln√©rabilit√© critique");

      // V√©rifier les logs d'acc√®s s√©curis√©s
      cy.get('[data-cy="access-logs"]')
        .should("contain", "Tous les acc√®s logg√©s")
        .should("contain", "Int√©grit√© v√©rifi√©e")
        .should("contain", "R√©tention: 7 ans");

      // Test de simulation d'intrusion
      cy.get('[data-cy="penetration-test"]').click();
      
      cy.get('[data-cy="pentest-warning"]', { timeout: 10000 })
        .should("contain", "Test d'intrusion simul√©")
        .should("contain", "Environnement isol√©");

      cy.get('[data-cy="confirm-pentest"]').click();

      cy.get('[data-cy="pentest-results"]', { timeout: 30000 })
        .should("be.visible")
        .should("contain", "Aucune faille d√©tect√©e")
        .should("contain", "D√©fenses efficaces")
        .should("contain", "Recommandations: 0");
    });
  });

  afterEach(() => {
    // Nettoyage apr√®s chaque test
    cy.window().then((win) => {
      win.localStorage.clear();
      win.sessionStorage.clear();
    });
  });
});