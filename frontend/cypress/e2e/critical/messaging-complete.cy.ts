/// <reference types="cypress" />

/**
 * Tests E2E - Syst√®me de Messagerie Compl√®te
 * 
 * Tests du syst√®me de messagerie temps r√©el avec workflows client ‚Üî admin,
 * gestion des fichiers, notifications email et threading avanc√©.
 * 
 * Couverture :
 * - Envoi/r√©ception messages client ‚Üî admin
 * - Upload/t√©l√©chargement fichiers dans messages
 * - Notifications email automatiques
 * - Threading des conversations
 * - Messages de support depuis formulaires publics
 * - Gestion des erreurs (√©chec upload, email bounce, timeout)
 */

describe("üîî Syst√®me de Messagerie Compl√®te - Tests E2E", () => {
  const testMessage = {
    subject: "Test E2E - Correction manuscrit",
    content: "Bonjour, j'ai besoin d'une correction compl√®te de mon manuscrit de 200 pages.",
    threadId: `thread_${Date.now()}`,
    fileName: "manuscript-test.pdf",
    fileSize: "2.5 MB"
  };

  const testFiles = {
    validPdf: "cypress/fixtures/test-manuscript.pdf",
    validDoc: "cypress/fixtures/test-document.docx", 
    invalidFile: "cypress/fixtures/test-image.jpg",
    largeFile: "cypress/fixtures/large-document.pdf"
  };

  beforeEach(() => {
    // R√©initialiser l'√©tat des tests
    cy.resetDatabase();
    cy.visit("/");
    cy.wait(1000);
  });

  context("üì® Workflows Client ‚Üî Admin", () => {
    it("devrait permettre l'envoi de message client ‚Üí admin avec accus√© r√©ception", () => {
      // 1. Connexion en tant que client
      cy.loginAsUser();
      cy.visit("/messages");
      cy.wait(2000);

      // 2. Cr√©er un nouveau message
      cy.get('[data-cy="new-message-btn"]', { timeout: 10000 })
        .should("be.visible")
        .click();

      cy.get('[data-cy="message-subject"]')
        .type(testMessage.subject);

      cy.get('[data-cy="message-content"]')
        .type(testMessage.content);

      // 3. Attacher un fichier
      cy.get('[data-cy="file-upload"]')
        .selectFile(testFiles.validPdf, { force: true });

      // V√©rifier l'aper√ßu du fichier
      cy.get('[data-cy="file-preview"]')
        .should("contain", "test-manuscript.pdf")
        .should("contain", "PDF");

      // 4. Envoyer le message
      cy.get('[data-cy="send-message-btn"]').click();

      // 5. V√©rifications c√¥t√© client
      cy.get('[data-cy="message-sent-success"]', { timeout: 15000 })
        .should("be.visible")
        .should("contain", "Message envoy√© avec succ√®s");

      // V√©rifier que le message appara√Æt dans la liste
      cy.get('[data-cy="message-list"]')
        .should("contain", testMessage.subject)
        .should("contain", "En attente de r√©ponse");

      // 6. V√©rifier la notification email (mock)
      cy.request({
        method: "GET",
        url: `${Cypress.env("API_BASE_URL")}/dev/last-email`,
        failOnStatusCode: false
      }).then((response) => {
        if (response.status === 200) {
          expect(response.body).to.have.property("to");
          expect(response.body.subject).to.contain("Nouveau message client");
          expect(response.body.html).to.contain(testMessage.subject);
        }
      });
    });

    it("devrait permettre la r√©ponse admin ‚Üí client avec threading", () => {
      // 1. Cr√©er un message initial c√¥t√© client
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type(testMessage.subject);
      cy.get('[data-cy="message-content"]').type(testMessage.content);
      cy.get('[data-cy="send-message-btn"]').click();
      cy.wait(3000);

      // 2. Basculer c√¥t√© admin
      cy.logout();
      cy.loginAsAdmin();
      cy.visit("/admin/messages");
      cy.wait(2000);

      // 3. Ouvrir le message client
      cy.get('[data-cy="message-list"]')
        .contains(testMessage.subject)
        .click();

      cy.get('[data-cy="message-thread"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", testMessage.content);

      // 4. R√©pondre au message
      const adminReply = "Bonjour, nous avons bien re√ßu votre demande. Nous vous recontacterons sous 24h.";
      
      cy.get('[data-cy="reply-content"]')
        .type(adminReply);

      // Attacher un fichier de devis
      cy.get('[data-cy="reply-file-upload"]')
        .selectFile(testFiles.validDoc, { force: true });

      cy.get('[data-cy="send-reply-btn"]').click();

      // 5. V√©rifications c√¥t√© admin
      cy.get('[data-cy="reply-sent-success"]', { timeout: 15000 })
        .should("be.visible");

      // V√©rifier le threading
      cy.get('[data-cy="message-thread"]')
        .should("contain", testMessage.content) // Message original
        .should("contain", adminReply); // R√©ponse admin

      // 6. V√©rifier c√¥t√© client
      cy.logout();
      cy.loginAsUser();
      cy.visit("/messages");

      cy.get('[data-cy="message-list"]')
        .contains(testMessage.subject)
        .should("contain", "Nouvelle r√©ponse") // Indicateur de nouvelle r√©ponse
        .click();

      cy.get('[data-cy="message-thread"]')
        .should("contain", adminReply)
        .should("contain", "test-document.docx"); // Fichier joint
    });

    it("devrait g√©rer les conversations multiples avec √©tats corrects", () => {
      const messages = [
        { subject: "Correction Roman", content: "Roman de 300 pages", priority: "HAUTE" },
        { subject: "Relecture Essai", content: "Essai de 150 pages", priority: "NORMALE" },
        { subject: "Coaching √âcriture", content: "S√©ances de coaching", priority: "BASSE" }
      ];

      cy.loginAsUser();
      cy.visit("/messages");

      // Cr√©er plusieurs messages
      messages.forEach((message, index) => {
        cy.get('[data-cy="new-message-btn"]').click();
        cy.get('[data-cy="message-subject"]').type(message.subject);
        cy.get('[data-cy="message-content"]').type(message.content);
        
        if (index === 0) {
          // Premier message avec fichier
          cy.get('[data-cy="file-upload"]')
            .selectFile(testFiles.validPdf, { force: true });
        }
        
        cy.get('[data-cy="send-message-btn"]').click();
        cy.wait(2000);
        
        // Fermer le modal/form si ouvert
        cy.get('body').then(($body) => {
          if ($body.find('[data-cy="close-message-form"]').length > 0) {
            cy.get('[data-cy="close-message-form"]').click();
          }
        });
      });

      // V√©rifier la liste des messages
      cy.get('[data-cy="message-list"]')
        .should("contain", "Correction Roman")
        .should("contain", "Relecture Essai")
        .should("contain", "Coaching √âcriture");

      // V√©rifier les filtres
      cy.get('[data-cy="filter-priority"]').select("HAUTE");
      cy.get('[data-cy="message-list"]')
        .should("contain", "Correction Roman")
        .should("not.contain", "Relecture Essai");

      // V√©rifier la recherche
      cy.get('[data-cy="message-search"]').type("Roman");
      cy.get('[data-cy="message-list"]')
        .should("contain", "Correction Roman")
        .should("not.contain", "Coaching √âcriture");
    });
  });

  context("üìé Gestion des Fichiers", () => {
    it("devrait permettre l'upload de fichiers multiples avec validation", () => {
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();

      // Test des formats accept√©s
      const validFiles = [testFiles.validPdf, testFiles.validDoc];
      
      validFiles.forEach((file, index) => {
        cy.get('[data-cy="file-upload"]')
          .selectFile(file, { action: 'select', force: true });
        
        cy.get(`[data-cy="file-preview-${index}"]`, { timeout: 10000 })
          .should("be.visible");
      });

      // V√©rifier la liste des fichiers
      cy.get('[data-cy="files-list"]')
        .should("contain", "test-manuscript.pdf")
        .should("contain", "test-document.docx");

      // Test de suppression de fichier
      cy.get('[data-cy="remove-file-0"]').click();
      cy.get('[data-cy="files-list"]')
        .should("not.contain", "test-manuscript.pdf")
        .should("contain", "test-document.docx");
    });

    it("devrait rejeter les fichiers invalides avec messages d'erreur", () => {
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();

      // Test fichier non autoris√© (image)
      cy.get('[data-cy="file-upload"]')
        .selectFile(testFiles.invalidFile, { force: true });

      cy.get('[data-cy="file-error"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Format de fichier non autoris√©");

      // Test fichier trop volumineux
      cy.get('[data-cy="file-upload"]')
        .selectFile(testFiles.largeFile, { force: true });

      cy.get('[data-cy="file-error"]')
        .should("contain", "Fichier trop volumineux");
    });

    it("devrait permettre le t√©l√©chargement s√©curis√© des fichiers joints", () => {
      // 1. Cr√©er un message avec fichier
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type("Test t√©l√©chargement");
      cy.get('[data-cy="file-upload"]')
        .selectFile(testFiles.validPdf, { force: true });
      cy.get('[data-cy="send-message-btn"]').click();
      cy.wait(3000);

      // 2. Ouvrir le message et tester le t√©l√©chargement
      cy.get('[data-cy="message-list"]')
        .contains("Test t√©l√©chargement")
        .click();

      cy.get('[data-cy="file-download"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "test-manuscript.pdf");

      // V√©rifier l'URL de t√©l√©chargement s√©curis√©e
      cy.get('[data-cy="file-download"]')
        .should("have.attr", "href")
        .and("include", "/api/files/download/")
        .and("include", "token=");

      // Test du t√©l√©chargement (simulation)
      cy.get('[data-cy="file-download"]').click();
      cy.wait(2000);

      // V√©rifier qu'aucune erreur n'est survenue
      cy.get('[data-cy="download-error"]').should("not.exist");
    });

    it("devrait g√©rer les erreurs d'upload avec retry automatique", () => {
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();

      // Simuler une erreur r√©seau lors de l'upload
      cy.intercept("POST", "**/files/upload", {
        statusCode: 500,
        body: { error: "Erreur serveur" }
      }).as("uploadError");

      cy.get('[data-cy="file-upload"]')
        .selectFile(testFiles.validPdf, { force: true });

      cy.wait("@uploadError");

      // V√©rifier l'affichage de l'erreur
      cy.get('[data-cy="upload-error"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "√âchec de l'upload");

      // V√©rifier le bouton de retry
      cy.get('[data-cy="retry-upload"]')
        .should("be.visible")
        .click();

      // Simuler le succ√®s au retry
      cy.intercept("POST", "**/files/upload", {
        statusCode: 200,
        body: { 
          fileId: "file_123",
          fileName: "test-manuscript.pdf",
          fileUrl: "/files/file_123"
        }
      }).as("uploadSuccess");

      cy.wait("@uploadSuccess");

      cy.get('[data-cy="file-preview"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "test-manuscript.pdf");
    });
  });

  context("üìß Notifications Email Automatiques", () => {
    it("devrait envoyer des notifications email pour nouveaux messages", () => {
      // Mock du service email
      cy.intercept("POST", "**/emails/send", {
        statusCode: 200,
        body: { messageId: "email_123", status: "sent" }
      }).as("emailSent");

      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type("Test notification email");
      cy.get('[data-cy="message-content"]').type("Test du syst√®me de notifications");
      cy.get('[data-cy="send-message-btn"]').click();

      cy.wait("@emailSent");

      // V√©rifier que l'email a √©t√© envoy√©
      cy.get('@emailSent').should((interception) => {
        expect(interception.request.body).to.have.property('to');
        expect(interception.request.body).to.have.property('template', 'admin-message');
        expect(interception.request.body.data).to.have.property('messageSubject', 'Test notification email');
      });
    });

    it("devrait g√©rer les bounces et √©checs d'email", () => {
      // Simuler un √©chec d'envoi d'email
      cy.intercept("POST", "**/emails/send", {
        statusCode: 422,
        body: { error: "Email bounce", details: "Invalid email address" }
      }).as("emailBounce");

      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type("Test email bounce");
      cy.get('[data-cy="send-message-btn"]').click();

      cy.wait("@emailBounce");

      // V√©rifier la gestion de l'erreur
      cy.get('[data-cy="email-warning"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "La notification email n'a pas pu √™tre envoy√©e");

      // Le message doit quand m√™me √™tre sauvegard√©
      cy.get('[data-cy="message-sent-success"]')
        .should("be.visible");
    });

    it("devrait envoyer des notifications de suivi pour r√©ponses", () => {
      // 1. Message initial
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type("Test suivi");
      cy.get('[data-cy="send-message-btn"]').click();
      cy.wait(2000);

      // 2. R√©ponse admin
      cy.logout();
      cy.loginAsAdmin();
      cy.visit("/admin/messages");

      cy.intercept("POST", "**/emails/send", {
        statusCode: 200,
        body: { messageId: "email_reply_123", status: "sent" }
      }).as("replyEmailSent");

      cy.get('[data-cy="message-list"]')
        .contains("Test suivi")
        .click();

      cy.get('[data-cy="reply-content"]')
        .type("R√©ponse de l'√©quipe admin");
      cy.get('[data-cy="send-reply-btn"]').click();

      cy.wait("@replyEmailSent");

      // V√©rifier l'email de notification au client
      cy.get('@replyEmailSent').should((interception) => {
        expect(interception.request.body.template).to.eq('client-message-reply');
        expect(interception.request.body.data).to.have.property('replyContent');
      });
    });
  });

  context("üåê Messages de Support Public", () => {
    it("devrait permettre l'envoi de messages depuis le formulaire public", () => {
      // Acc√©der au formulaire de contact public (sans auth)
      cy.visit("/contact");
      cy.wait(2000);

      // Remplir le formulaire
      cy.get('[data-cy="contact-name"]').type("Jean Dupont");
      cy.get('[data-cy="contact-email"]').type("jean.dupont@example.com");
      cy.get('[data-cy="contact-subject"]').type("Demande d'information");
      cy.get('[data-cy="contact-message"]').type("Bonjour, j'aimerais conna√Ætre vos tarifs pour la correction d'un roman de 250 pages.");
      
      // Joindre un √©chantillon
      cy.get('[data-cy="contact-file"]')
        .selectFile(testFiles.validPdf, { force: true });

      cy.get('[data-cy="submit-contact"]').click();

      // V√©rifications
      cy.get('[data-cy="contact-success"]', { timeout: 15000 })
        .should("be.visible")
        .should("contain", "Votre message a √©t√© envoy√©");

      // V√©rifier que le message appara√Æt c√¥t√© admin
      cy.loginAsAdmin();
      cy.visit("/admin/messages");

      cy.get('[data-cy="message-list"]')
        .should("contain", "Demande d'information")
        .should("contain", "jean.dupont@example.com")
        .should("contain", "Nouveau"); // Statut
    });

    it("devrait cr√©er automatiquement un thread de support", () => {
      // 1. Message public
      cy.visit("/contact");
      cy.get('[data-cy="contact-name"]').type("Marie Martin");
      cy.get('[data-cy="contact-email"]').type("marie.martin@example.com");
      cy.get('[data-cy="contact-subject"]').type("Question sur d√©lais");
      cy.get('[data-cy="contact-message"]').type("Quels sont vos d√©lais pour une correction de 100 pages ?");
      cy.get('[data-cy="submit-contact"]').click();
      cy.wait(3000);

      // 2. R√©ponse admin
      cy.loginAsAdmin();
      cy.visit("/admin/messages");
      cy.get('[data-cy="message-list"]')
        .contains("Question sur d√©lais")
        .click();

      cy.get('[data-cy="reply-content"]')
        .type("Bonjour Marie, nos d√©lais sont g√©n√©ralement de 7 √† 10 jours ouvr√©s pour 100 pages.");
      cy.get('[data-cy="send-reply-btn"]').click();
      cy.wait(2000);

      // 3. V√©rifier le thread complet
      cy.get('[data-cy="message-thread"]')
        .should("contain", "marie.martin@example.com") // Exp√©diteur original
        .should("contain", "Quels sont vos d√©lais") // Message original
        .should("contain", "7 √† 10 jours ouvr√©s") // R√©ponse admin
        .should("contain", "Thread ID:"); // Identifiant de thread

      // 4. V√©rifier l'historique des interactions
      cy.get('[data-cy="thread-history"]')
        .should("contain", "Message initial re√ßu")
        .should("contain", "R√©ponse envoy√©e");
    });
  });

  context("‚ö†Ô∏è Gestion des Erreurs et Edge Cases", () => {
    it("devrait g√©rer les timeouts de connexion", () => {
      // Simuler une latence extr√™me
      cy.intercept("POST", "**/messages", (req) => {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({ statusCode: 200, body: { messageId: "msg_123" } });
          }, 20000); // 20 secondes (plus que le timeout)
        });
      }).as("slowMessage");

      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();
      cy.get('[data-cy="message-subject"]').type("Test timeout");
      cy.get('[data-cy="send-message-btn"]').click();

      // V√©rifier la gestion du timeout
      cy.get('[data-cy="message-timeout-error"]', { timeout: 25000 })
        .should("be.visible")
        .should("contain", "La connexion a pris trop de temps");

      // V√©rifier les options de r√©cup√©ration
      cy.get('[data-cy="retry-send"]')
        .should("be.visible");
      
      cy.get('[data-cy="save-draft"]')
        .should("be.visible");
    });

    it("devrait permettre la r√©cup√©ration automatique des brouillons", () => {
      cy.loginAsUser();
      cy.visit("/messages");
      cy.get('[data-cy="new-message-btn"]').click();

      // Commencer √† √©crire un message
      const draftContent = "Ceci est un brouillon de message...";
      cy.get('[data-cy="message-subject"]').type("Brouillon test");
      cy.get('[data-cy="message-content"]').type(draftContent);

      // Simuler une fermeture accidentelle
      cy.reload();
      cy.wait(2000);

      // V√©rifier la r√©cup√©ration du brouillon
      cy.get('[data-cy="draft-recovered"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Brouillon r√©cup√©r√©");

      cy.get('[data-cy="restore-draft"]').click();

      // V√©rifier que le contenu est restaur√©
      cy.get('[data-cy="message-subject"]')
        .should("have.value", "Brouillon test");
      
      cy.get('[data-cy="message-content"]')
        .should("contain", draftContent);
    });

    it("devrait g√©rer la perte de connexion r√©seau", () => {
      cy.loginAsUser();
      cy.visit("/messages");

      // Simuler une perte de connexion
      cy.intercept("GET", "**/messages**", { forceNetworkError: true }).as("networkError");
      
      cy.get('[data-cy="refresh-messages"]').click();
      cy.wait("@networkError");

      // V√©rifier l'indicateur de connexion
      cy.get('[data-cy="connection-status"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Connexion perdue");

      // V√©rifier le mode d√©grad√©
      cy.get('[data-cy="offline-mode"]')
        .should("be.visible")
        .should("contain", "Mode hors ligne activ√©");

      // Simuler le retour de la connexion
      cy.intercept("GET", "**/messages**", {
        statusCode: 200,
        body: { messages: [], total: 0 }
      }).as("connectionRestored");

      cy.get('[data-cy="retry-connection"]').click();
      cy.wait("@connectionRestored");

      cy.get('[data-cy="connection-status"]')
        .should("contain", "Connexion r√©tablie");
    });

    it("devrait limiter le spam et les messages abusifs", () => {
      cy.loginAsUser();
      cy.visit("/messages");

      // Envoyer plusieurs messages rapidement
      for (let i = 0; i < 6; i++) {
        cy.get('[data-cy="new-message-btn"]').click();
        cy.get('[data-cy="message-subject"]').type(`Message spam ${i}`);
        cy.get('[data-cy="send-message-btn"]').click();
        cy.wait(500);

        // Fermer le modal si ouvert
        cy.get('body').then(($body) => {
          if ($body.find('[data-cy="close-message-form"]').length > 0) {
            cy.get('[data-cy="close-message-form"]').click();
          }
        });
      }

      // V√©rifier la limitation de d√©bit
      cy.get('[data-cy="rate-limit-warning"]', { timeout: 10000 })
        .should("be.visible")
        .should("contain", "Trop de messages envoy√©s");

      // V√©rifier le blocage temporaire
      cy.get('[data-cy="new-message-btn"]')
        .should("be.disabled");

      cy.get('[data-cy="cooldown-timer"]')
        .should("be.visible")
        .should("contain", "Veuillez patienter");
    });
  });

  afterEach(() => {
    // Nettoyage apr√®s chaque test
    cy.window().then((win) => {
      win.localStorage.clear();
      win.sessionStorage.clear();
    });
  });
});