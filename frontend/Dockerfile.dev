FROM node:18.20.2-alpine

# Dépendances pour healthcheck
RUN apk add --no-cache curl netcat-openbsd

# Créer répertoire de travail global (racine repo)
WORKDIR /repo

# Copier tous les fichiers nécessaires pour build complet
COPY package*.json ./
COPY frontend/package*.json frontend/
COPY shared/ shared/
COPY frontend/ frontend/

# Installer les dépendances depuis la racine
RUN npm install

# Exposer les ports (Vite + healthcheck)
EXPOSE 5173 8080

# Healthcheck server
RUN echo '#!/bin/sh' > /healthcheck.sh && \
    echo 'while true; do' >> /healthcheck.sh && \
    echo '  echo "HTTP/1.1 200 OK\nContent-Type: text/plain\nContent-Length: 2\n\nOK" | nc -l -p 8080 -q 1' >> /healthcheck.sh && \
    echo 'done' >> /healthcheck.sh && \
    chmod +x /healthcheck.sh

CMD ["/bin/sh", "-c", "/healthcheck.sh & tail -f /dev/null"]
