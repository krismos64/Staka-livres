#!/bin/bash

# üöÄ SCRIPT DE D√âPLOIEMENT PRODUCTION - STAKA LIVRES
# 
# Script automatis√© pour le d√©ploiement s√©curis√© sur VPS OVH
# G√©n√®re les secrets, guide la configuration et lance Docker
# 
# Usage: ./scripts/deploy-production.sh
# 
# @author Staka Livres Team
# @version 2.0.0
# @date 2025-07-22

set -e  # Arr√™t imm√©diat en cas d'erreur

# üé® Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# üìã Configuration
ENV_FILE="backend/.env.production"
BACKUP_DIR="backup/secrets"
LOG_FILE="deployment.log"

# üîß Fonctions utilitaires
log() {
    echo -e "${CYAN}[$(date '+%Y-%m-%d %H:%M:%S')] $1${NC}" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}‚ùå ERREUR: $1${NC}" | tee -a "$LOG_FILE"
    exit 1
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}" | tee -a "$LOG_FILE"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è $1${NC}" | tee -a "$LOG_FILE"
}

# üîç V√©rifications pr√©alables
check_prerequisites() {
    log "V√©rification des pr√©requis..."
    
    # Node.js
    if ! command -v node &> /dev/null; then
        error "Node.js n'est pas install√©. Installez Node.js >= 16.x"
    fi
    success "Node.js disponible: $(node --version)"
    
    # Docker
    if ! command -v docker &> /dev/null; then
        error "Docker n'est pas install√©"
    fi
    success "Docker disponible: $(docker --version)"
    
    # Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        error "Docker Compose n'est pas install√©"
    fi
    success "Docker Compose disponible: $(docker-compose --version)"
    
    # Permissions script generateSecrets.js
    if [[ ! -x "backend/scripts/generateSecrets.js" ]]; then
        chmod +x backend/scripts/generateSecrets.js
        success "Permissions script secrets corrig√©es"
    fi
}

# üîí G√©n√©ration des secrets
generate_secrets() {
    log "üîê G√©n√©ration des secrets de production..."
    
    # Sauvegarde ancien fichier si existe
    if [[ -f "$ENV_FILE" ]]; then
        mkdir -p "$BACKUP_DIR"
        cp "$ENV_FILE" "$BACKUP_DIR/.env.production.backup.$(date +%Y%m%d_%H%M%S)"
        warning "Ancien fichier .env.production sauvegard√©"
    fi
    
    # G√©n√©ration nouveaux secrets
    if node backend/scripts/generateSecrets.js --output "$ENV_FILE"; then
        success "Secrets g√©n√©r√©s avec succ√®s dans $ENV_FILE"
    else
        error "√âchec de la g√©n√©ration des secrets"
    fi
    
    # V√©rification permissions
    if [[ $(stat -c %a "$ENV_FILE" 2>/dev/null || stat -f %A "$ENV_FILE" 2>/dev/null) != "600" ]]; then
        warning "Permissions du fichier secrets non s√©curis√©es"
        chmod 600 "$ENV_FILE"
        success "Permissions s√©curis√©es (600)"
    fi
}

# ‚úèÔ∏è Configuration manuelle
configure_secrets() {
    log "üìù Configuration manuelle des secrets..."
    
    echo -e "${BOLD}${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë               CONFIGURATION MANUELLE REQUISE              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    echo -e "${YELLOW}Vous devez maintenant √©diter le fichier $ENV_FILE et remplacer:"
    echo -e "  ‚Ä¢ SENDGRID_API_KEY=\"SG.VOTRE_CLE_SENDGRID_PRODUCTION_ICI\""
    echo -e "  ‚Ä¢ STRIPE_SECRET_KEY=\"sk_live_VOTRE_CLE_STRIPE_LIVE_ICI\""
    echo -e "  ‚Ä¢ STRIPE_WEBHOOK_SECRET=\"whsec_VOTRE_WEBHOOK_SECRET_STRIPE_ICI\""
    echo -e "  ‚Ä¢ AWS_ACCESS_KEY_ID=\"AKIA_VOTRE_ACCESS_KEY_PRODUCTION_ICI\""
    echo -e "${NC}"
    
    # Ouverture automatique de l'√©diteur
    if command -v nano &> /dev/null; then
        EDITOR="nano"
    elif command -v vim &> /dev/null; then
        EDITOR="vim"
    elif command -v vi &> /dev/null; then
        EDITOR="vi"
    else
        EDITOR=""
    fi
    
    if [[ -n "$EDITOR" ]]; then
        echo -e "${CYAN}Ouverture de l'√©diteur $EDITOR...${NC}"
        echo -e "${YELLOW}üí° Conseil: Recherchez 'VOTRE_' pour trouver les valeurs √† remplacer${NC}"
        sleep 3
        $EDITOR "$ENV_FILE"
    else
        warning "Aucun √©diteur de texte trouv√©"
        echo -e "${YELLOW}√âditez manuellement le fichier: $ENV_FILE${NC}"
    fi
    
    # Validation
    while true; do
        echo
        read -p "‚è∏Ô∏è Configuration termin√©e ? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            break
        elif [[ $REPLY =~ ^[Nn]$ ]]; then
            if [[ -n "$EDITOR" ]]; then
                $EDITOR "$ENV_FILE"
            else
                echo -e "${YELLOW}Continuez l'√©dition manuelle de $ENV_FILE${NC}"
            fi
        fi
    done
    
    success "Configuration manuelle termin√©e"
}

# üîç Validation des secrets
validate_secrets() {
    log "üîç Validation de la configuration..."
    
    # V√©rifier que les valeurs ont √©t√© remplac√©es
    local issues=0
    
    if grep -q "VOTRE_" "$ENV_FILE"; then
        warning "Certaines valeurs n'ont pas √©t√© remplac√©es:"
        grep "VOTRE_" "$ENV_FILE" | sed 's/^/    /'
        ((issues++))
    fi
    
    # V√©rifier secrets g√©n√©r√©s pr√©sents
    local required_secrets=("JWT_SECRET" "MYSQL_ROOT_PASSWORD" "MYSQL_PASSWORD")
    for secret in "${required_secrets[@]}"; do
        if ! grep -q "^$secret=" "$ENV_FILE"; then
            warning "Secret manquant: $secret"
            ((issues++))
        fi
    done
    
    if [[ $issues -gt 0 ]]; then
        echo
        read -p "‚ö†Ô∏è Des probl√®mes ont √©t√© d√©tect√©s. Continuer quand m√™me ? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            error "D√©ploiement annul√© - Corrigez la configuration"
        fi
        warning "D√©ploiement avec probl√®mes de configuration"
    else
        success "Configuration valide"
    fi
}

# üèóÔ∏è Pr√©paration Docker
prepare_docker() {
    log "üèóÔ∏è Pr√©paration de l'environnement Docker..."
    
    # V√©rifier docker-compose.prod.yml existe
    if [[ ! -f "docker-compose.prod.yml" ]]; then
        warning "docker-compose.prod.yml non trouv√©, utilisation de docker-compose.yml"
        COMPOSE_FILE="docker-compose.yml"
    else
        COMPOSE_FILE="docker-compose.prod.yml"
        success "Fichier Docker Compose trouv√©: $COMPOSE_FILE"
    fi
    
    # Nettoyer images anciennes si demand√©
    echo
    read -p "üßπ Nettoyer les images Docker anciennes ? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log "Nettoyage des images Docker..."
        docker system prune -f
        success "Images Docker nettoy√©es"
    fi
}

# üöÄ D√©ploiement
deploy_application() {
    log "üöÄ Lancement du d√©ploiement Docker..."
    
    # Build et d√©marrage
    if docker-compose -f "$COMPOSE_FILE" up -d --build; then
        success "Services Docker d√©marr√©s avec succ√®s"
    else
        error "√âchec du d√©marrage des services Docker"
    fi
    
    # Attendre que les services soient pr√™ts
    log "‚è≥ Attente du d√©marrage des services..."
    sleep 30
    
    # V√©rifier statut des containers
    log "üìä V√©rification du statut des services..."
    docker-compose -f "$COMPOSE_FILE" ps
    
    # Test connectivit√© basique
    if docker-compose -f "$COMPOSE_FILE" exec -T backend curl -f http://localhost:3001/health &>/dev/null; then
        success "Backend accessible"
    else
        warning "Backend ne r√©pond pas au health check"
    fi
}

# üîç Validation post-d√©ploiement
post_deployment_validation() {
    log "üîç Validation post-d√©ploiement..."
    
    echo -e "${BOLD}${BLUE}üìä TESTS DE CONNECTIVIT√â:${NC}"
    
    # Test localhost (si sur le serveur)
    echo -e "${CYAN}Frontend local:${NC}"
    if curl -s -f http://localhost:3000 >/dev/null; then
        success "‚úÖ Frontend accessible sur localhost:3000"
    else
        warning "‚ùå Frontend inaccessible sur localhost:3000"
    fi
    
    echo -e "${CYAN}Backend API local:${NC}"
    if curl -s -f http://localhost:3001/health >/dev/null; then
        success "‚úÖ Backend API accessible sur localhost:3001"
    else
        warning "‚ùå Backend API inaccessible sur localhost:3001"
    fi
    
    # Afficher logs r√©cents
    echo -e "${CYAN}Logs r√©cents (30 derni√®res lignes):${NC}"
    docker-compose -f "$COMPOSE_FILE" logs --tail 30
}

# üìã Instructions finales
final_instructions() {
    echo -e "${BOLD}${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                  D√âPLOIEMENT TERMIN√â                      ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    
    echo -e "${BOLD}üéâ F√âLICITATIONS ! Le d√©ploiement est termin√©.${NC}\n"
    
    echo -e "${BOLD}üìã √âTAPES SUIVANTES POUR LA PRODUCTION:${NC}"
    echo -e "${YELLOW}1. Configuration DNS:${NC}"
    echo -e "   ‚Ä¢ Pointez livres.staka.fr vers l'IP de ce serveur"
    echo -e "   ‚Ä¢ Configurez les certificats SSL Let's Encrypt"
    echo -e ""
    echo -e "${YELLOW}2. Configuration Nginx reverse proxy:${NC}"
    echo -e "   ‚Ä¢ Suivez la checklist: docs/CHECKLIST_DEPLOIEMENT_OVH.md"
    echo -e "   ‚Ä¢ Configurez HTTPS avec certificats automatiques"
    echo -e ""
    echo -e "${YELLOW}3. Configuration Stripe:${NC}"
    echo -e "   ‚Ä¢ Dashboard Stripe: Webhooks > Add endpoint"
    echo -e "   ‚Ä¢ URL: https://livres.staka.fr/api/payments/webhook"
    echo -e "   ‚Ä¢ √âv√©nements: checkout.session.completed, payment_intent.payment_failed"
    echo -e ""
    echo -e "${YELLOW}4. Tests de production:${NC}"
    echo -e "   ‚Ä¢ curl https://livres.staka.fr"
    echo -e "   ‚Ä¢ curl https://livres.staka.fr/api/health"
    echo -e "   ‚Ä¢ Tests fonctionnels complets"
    echo -e ""
    echo -e "${BOLD}üìû SUPPORT:${NC}"
    echo -e "   ‚Ä¢ Documentation: docs/CHECKLIST_DEPLOIEMENT_OVH.md"
    echo -e "   ‚Ä¢ Logs: docker-compose -f $COMPOSE_FILE logs -f"
    echo -e "   ‚Ä¢ Email: support@staka-livres.fr"
    echo -e ""
    echo -e "${RED}üîí S√âCURIT√â - NE PAS OUBLIER:${NC}"
    echo -e "   ‚Ä¢ Sauvegardez $ENV_FILE dans un gestionnaire de mots de passe"
    echo -e "   ‚Ä¢ Ne jamais commiter les fichiers .env dans Git"
    echo -e "   ‚Ä¢ Changez les secrets en cas de compromission"
}

# üéØ Fonction principale
main() {
    clear
    echo -e "${BOLD}${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë         D√âPLOIEMENT PRODUCTION - STAKA LIVRES             ‚ïë"
    echo "‚ïë              VPS OVH - Docker Multi-services              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}\n"
    
    log "üöÄ D√©but du d√©ploiement production Staka Livres"
    
    # Ex√©cution s√©quentielle
    check_prerequisites
    generate_secrets
    configure_secrets
    validate_secrets
    prepare_docker
    deploy_application
    post_deployment_validation
    final_instructions
    
    success "D√©ploiement production termin√© avec succ√®s !"
    log "üìä Logs sauvegard√©s dans: $LOG_FILE"
}

# üõ°Ô∏è Gestion des erreurs
trap 'error "D√©ploiement interrompu"' INT TERM

# üöÄ Lancement
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi